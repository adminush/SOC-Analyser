@echo off
set Hostname=%1
powershell -Command "& {New-Item -Path '.\Result\' -Name "%Hostname%" -ItemType 'directory'}"
powershell -Command "& {New-Item -Path '.\Result\%Hostname%\' -Name "CMD" -ItemType 'directory'}"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '----------- Systeminfo -----------' >> C:\tmp\systeminfo.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '----------- Register info from HKLM -----------' >> C:\tmp\reg.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '----------- Local Network Info -----------' >> C:\tmp\network.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '----------- PowerShell History -----------' >> C:\tmp\ps_history.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '----------- Process Info (tasklist, services, tcp connection and other) -----------' >> C:\tmp\process.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '----------- Users Info -----------' >> C:\tmp\users.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "systeminfo >> C:\tmp\systeminfo.txt; echo '' >> C:\tmp\systeminfo.txt; echo '----------- etc hosts file-----------' >> C:\tmp\systeminfo.txt;  gc -tail 4 'C:\Windows\System32\Drivers\etc\hosts' >> C:\tmp\systeminfo.txt; gci 'C:\Windows\System32\Drivers\etc\hosts' | fl *Time* >> C:\tmp\systeminfo.txt; ipconfig /all >> C:\tmp\network.txt; netsh interface show interface >> C:\tmp\network.txt; netsh wlan show profile >> C:\tmp\network.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "Get-Item -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\Microsoft\'Windows NT'\CurrentVersion\IniFileMapping\system.ini\boot >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\'Shell Folders' >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\EXPLORER\ADVANCED\FOLDER\HIDDEN\SHOWALL >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\POLICIES\MICROSOFT\'WINDOWS NT'\'TERMINAL SERVICES' >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\MICROSOFT\'WINDOWS NT'\CURRENTVERSION\'IMAGE FILE EXECUTION OPTIONS' >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\POLICIES\SYSTEM >> C:\tmp\reg.txt; Get-Item -Path HKLM:\SOFTWARE\Microsoft\'Windows NT'\CurrentVersion\ProfileList >> C:\tmp\reg.txt; reg query "HKLM\SYSTEM\CurrentControlSet\Services\bam\state\UserSettings" /s >> C:\tmp\reg.txt;"
.\Resources\PsExec.exe \\%Hostname% powershell /c "$Users=(Gci C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt).FullName; $Pasts=@($Users);  foreach ($Past in $Pasts) { echo "`n----User Pwsh History Path $Past---`n" >> C:\tmp\ps_history.txt; get-content $Past >> C:\tmp\ps_history.txt}"
.\Resources\PsExec.exe \\%Hostname% powershell /c "tasklist >> C:\tmp\process.txt; Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\services\*' | where ImagePath -notlike '*System32*' | ft PSChildName, ImagePath -autosize | out-string -width 800 >> C:\tmp\process.txt; get-service | Select Name,DisplayName,Status | sort status -descending | ft -Property * -AutoSize | Out-String -Width 4096 >> C:\tmp\process.txt; Get-NetTCPConnection | select LocalAddress,localport,remoteaddress,remoteport,state,@{name='process';Expression={(get-process -id $_.OwningProcess).ProcessName}}, @{Name='cmdline';Expression={(Get-WmiObject Win32_Process -filter 'ProcessId = $($_.OwningProcess)').commandline}} | sort Remoteaddress -Descending | ft -wrap -autosize >> C:\tmp\process.txt"
.\Resources\PsExec.exe \\%Hostname% powershell /c "echo '' >> C:\tmp\users.txt; echo '----------- Active Sessions -----------' >> C:\tmp\users.txt; qwinsta >> C:\tmp\users.txt; echo '' >> C:\tmp\users.txt; echo '----------- Local Users -----------' >> C:\tmp\users.txt; Get-LocalUser | ? Enabled -eq 'True' >> C:\tmp\users.txt"
powershell -Command "& {Copy-Item \\%Hostname%\C$\tmp\systeminfo.txt -Destination .\Result\%Hostname%\CMD\; Remove-Item \\%Hostname%\C$\tmp\systeminfo.txt}"
powershell -Command "& {Copy-Item \\%Hostname%\C$\tmp\reg.txt -Destination .\Result\%Hostname%\CMD\; Remove-Item \\%Hostname%\C$\tmp\reg.txt}"
powershell -Command "& {Copy-Item \\%Hostname%\C$\tmp\network.txt -Destination .\Result\%Hostname%\CMD\; Remove-Item \\%Hostname%\C$\tmp\network.txt}"
powershell -Command "& {Copy-Item \\%Hostname%\C$\tmp\ps_history.txt -Destination .\Result\%Hostname%\CMD\; Remove-Item \\%Hostname%\C$\tmp\ps_history.txt}"
powershell -Command "& {Copy-Item \\%Hostname%\C$\tmp\process.txt -Destination .\Result\%Hostname%\CMD\; Remove-Item \\%Hostname%\C$\tmp\process.txt}"
powershell -Command "& {Copy-Item \\%Hostname%\C$\tmp\users.txt -Destination .\Result\%Hostname%\CMD\; Remove-Item \\%Hostname%\C$\tmp\users.txt}"